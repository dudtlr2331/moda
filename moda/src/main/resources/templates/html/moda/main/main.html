<!DOCTYPE html>
<html>
<head>
    <title>moda</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
<div class="logo">
    <img src="/images/logo.png" alt="로고 이미지">
</div>

<div class="login-text">
    <div th:if="${uId}">
        <span th:text="${uId} + '님 환영합니다.'"></span>
        <input type="button" class="w70" id="logout_btn" th:onclick="'location.href=\'/moda/logout\''" value="로그아웃">
        <input th:if="${uAdmin == '1'}" type="button" class="w70" id="admin_btn" onclick="openAdminPage()" value="관리">
    </div>
    <div th:if="${uId == null}">
        <input type="button" class="w70" th:onclick="'location.href=\'/moda/login.do\''" value="로그인"/>
    </div>
</div>

<div class="wrap_center">
    <div class="container">
        <div class="img_wrap">
            <div class="prev btnmove">
                <a href="#" title="이전"><i class="fa-solid fa-angle-left"></i></a>
            </div>
            <div class="next btnmove">
                <a href="#" title="다음"><i class="fa-solid fa-angle-right"></i></a>
            </div>
            <ul class="rollimgs"> </ul>
        </div>
    </div>
</div>

<!-- 가로 메뉴 -->
<ul class="horizontal-menu">
    <li><a href="#">신상</a></li>
    <li><a href="#">베스트</a></li>
    <li><a href="#">카테고리</a></li>
    <li><a href="#">장바구니</a></li>
    <li><a href="#">마이페이지</a></li>
</ul>

<!-- 슬라이더 컨테이너 -->
<div class="slider-container">
    <div class="slider">
        <div class="slide">
            <img src="/images/event1.jpg" alt="이미지 1">
        </div>
        <div class="slide">
            <img src="/images/event2.jpg" alt="이미지 2">
        </div>
        <div class="slide">
            <img src="/images/event3.jpg" alt="이미지 3">
        </div>
    </div>
    <button class="slider-button slider-button-prev" onclick="moveSlide(-1)">◄</button>
    <button class="slider-button slider-button-next" onclick="moveSlide(1)">►</button>
</div>
<p class="recommendation-text">오늘의 추천</p>

<!-- Thymeleaf 반복문을 이용하여 이미지를 동적으로 추가 -->
<div th:if="${mainHomeList != null and #lists.size(mainHomeList) gt 0}" class="img_area">
    <div th:each="item : ${mainHomeList}">
        <img th:src="${item.prodImg} + ${item.prodImgDtl}">
        <div class="txt_area">
            <div class="item_name" th:text="${item.prodName}"></div>
            <div class="item_price">
                <span class="color_red" th:text="${#numbers.formatInteger(item.prodPrice, 0, 'COMMA')} + '원'"></span>
            </div>
        </div>
        <div class="dim"></div>
    </div>
</div>
<div th:if="${mainHomeList == null or #lists.size(mainHomeList) == 0}">
    <div class="img_a">데이터가 없습니다.</div>
</div>

<!-- JavaScript 코드 추가 -->
<script>
    function fn_ajax(obj){
        let url = obj.url;
        let method = obj.method;
        let params = obj.params;
        let fn_success = obj.success;

        let httpRequest = new XMLHttpRequest();
        if(!httpRequest) {
            alert('XMLHTTP 인스턴스를 만들 수가 없어요 ㅠㅠ');
            return false;
        }
        httpRequest.onreadystatechange = ()=>{
            if (httpRequest.readyState === XMLHttpRequest.DONE) {
                if (httpRequest.status === 200) {
                    let res = httpRequest.responseText;
                    fn_success(JSON.parse(res));
                } else {
                    console.log(`code: ${httpRequest.status}`);
                    console.log(`message: ${httpRequest.responseText}`);
                    alert('request에 뭔가 문제가 있어요.');
                }
            }
        };
        httpRequest.open(method, url);
        /* httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); */
        if(method == 'get' || method =='GET'){
            httpRequest.send();
        }else{
            httpRequest.setRequestHeader('Content-Type', 'application/json');
            httpRequest.send(params);
        }
    }


    let currentSlide = 0;
    const slides = document.querySelectorAll('.slide');
    const slideCount = slides.length;

    //뒤로가기 못하게 하는 로직
    window.history.pushState(null, "", window.location.href);
    window.onpopstate = function() {
        window.history.pushState(null, "", window.location.href);
    };

    //관리자 페이지를 새탭에서 열기
    function openAdminPage() {
        window.open('/adm/product/prodList.do', '_blank');
    }

    function showSlide(n) {
        slides.forEach(slide => slide.style.display = 'none');
        slides[n].style.display = 'block';
    }

    function moveSlide(n) {
        currentSlide = (currentSlide + n + slideCount) % slideCount;
        showSlide(currentSlide);
    }

    showSlide(currentSlide);
    document.querySelector('.slider-button-prev').addEventListener('click', () => moveSlide(-1));
    document.querySelector('.slider-button-next').addEventListener('click', () => moveSlide(1));



    let banner = {
        rollId: null,
        interval: 2000,

        //롤링 배너 초기화
        rollInit: function (newinterval) {
            if(parseInt(newinterval) > 0){
                this.interval = newinterval;
            }
            //현재 배너
            let firstitem = document.querySelector('.rollimgs li');
            if(firstitem){
                firstitem.classList.add('currentroll');
            }
            //다음 배너
            let seconditem = document.querySelectorAll('.rollimgs li')[1];
            if(seconditem){
                seconditem.classList.add('nextroll');
            }
            //이전 배너
            document.querySelector('.rollimgs li:last-child').classList.add('prevroll');
            this.rollId = setInterval(this.rollNext, this.interval);//롤링 인터벌 호출
        },

        //다음 배너 롤링
        rollNext: function () {
            if(document.querySelector('.prevroll')){
                document.querySelector('.prevroll').classList.remove('prevroll');
            }
            if(document.querySelector('.currentroll')){
                document.querySelector('.currentroll').classList.add('prevroll');
                document.querySelector('.currentroll').classList.remove('currentroll');
            }
            if(document.querySelector('.nextroll')){
                document.querySelector('.nextroll').classList.add('currentroll');
                document.querySelector('.nextroll').classList.remove('nextroll');
            }
            //다음 이미지 있으면 다음 롤링 이미지로 선택, 없으면 첫번째 이미지를 롤링 이미지로 지정
            if(document.querySelector('.currentroll').nextElementSibling){
                document.querySelector('.currentroll').nextElementSibling.classList.add('nextroll');
            }else{
                document.querySelector('.rollimgs li').classList.add('nextroll');
            }
        }
    };

    let eventList = null;
    document.addEventListener('DOMContentLoaded', function(){
        fn_ajax({
            url: '/adm/event/admEventListAjax.do',
            method: 'get',
            success: function(data){
                eventList = data.data

                if (eventList && eventList.length > 0) {
                    for(var i=0; i<eventList.length; i++){
                        document.querySelector(".rollimgs").innerHTML += '<li><img src="'+eventList[i].imgPath+eventList[i].imgNm+'"/></li>';
                    }
                    banner.rollInit(4000); // 배너 롤링
                } else {
                    console.error('Invalid or empty eventList:', eventList);
                }
            }
        });
    });
</script>
</body>
</html>